<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•‘æ€¥æ•‘å‘½å£«éŒ¬æˆè©¦é¨“å¯¾ç­– Webã‚¢ãƒ—ãƒª</title>
    <style>
        /* CSSå¤‰æ•°å®šç¾©: JavaScriptã§å‹•çš„ã«å¤‰æ›´ã•ã‚Œã¾ã™ */
        :root {
            --question-font-size: 1.05rem; 
            --option-font-size: 0.95rem;
        }
        
        /* --- ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š (CSS) --- */
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .card {
            background: white;
            width: 100%;
            max-width: 600px;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }
        h1 {
            font-size: 1.2rem;
            color: #1a73e8;
            text-align: center;
            margin-bottom: 25px;
            font-weight: 700;
            letter-spacing: 0.05em;
        }
        
        /* ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨å‡ºé¡Œé †ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’ã¾ã¨ã‚ã‚‹ */
        .category-controls {
            margin-bottom: 15px; 
            text-align: center;
            display: flex;
            justify-content: center;
            flex-wrap: wrap; 
            gap: 15px;
        }
        .category-controls label, .category-controls select {
            font-size: 1rem;
        }
        .category-controls select {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        /* ãƒ¢ãƒ¼ãƒ‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¨æ–‡å­—ã‚µã‚¤ã‚ºã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’ã¾ã¨ã‚ã‚‹ */
        .mode-controls {
            display: flex;
            flex-direction: column; /* è¦ç´ ã‚’ç¸¦ã«ä¸¦ã¹ã‚‹ */
            align-items: stretch; /* å¹…ã‚’æƒãˆã‚‹ */
            margin-bottom: 20px;
            gap: 10px; /* è¦ç´ é–“ã®éš™é–“ */
        }
        
        /* èª¤ç­”ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãƒªã‚»ãƒƒãƒˆã€æ–‡å­—ã‚µã‚¤ã‚ºã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹ãƒ©ãƒƒãƒ‘ãƒ¼ */
        .mode-row { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .mode-row > * {
            flex-grow: 1; /* å‡ç­‰ãªå¹…ã‚’ç¢ºä¿ */
        }

        /* æ–‡å­—ã‚µã‚¤ã‚ºã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        .font-size-control {
            display: flex;
            align-items: center;
            gap: 5px;
            justify-content: flex-end; /* å³å¯„ã› */
            flex-shrink: 0; /* ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã«ç¸®ã¾ãªã„ã‚ˆã†ã« */
        }
        .font-size-control label {
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .font-size-control select {
            padding: 5px 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 0.9rem;
            width: auto; /* ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦èª¿æ•´ */
            flex-shrink: 0;
        }
        
        /* èª¤ç­”ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã¨ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #review-mode-btn {
            padding: 10px 20px;
            border: 2px solid #e76f51; 
            background: white; 
            color: #e76f51; 
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        #review-mode-btn[style*="background-color: rgb(231, 111, 81)"] {
            background-color: #e76f51 !important;
            color: white !important;
        }
        #reset-review-btn {
            padding: 10px 15px;
            border: 2px solid #ccc; 
            background: #f4f4f4; 
            color: #777; 
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        /* 5å•ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #quick-five-btn {
            padding: 10px 20px;
            border: 2px solid #2a9d8f; 
            background: white; 
            color: #2a9d8f; 
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%; 
        }

        #quick-five-btn[style*="background-color: rgb(42, 157, 143)"] {
            background-color: #2a9d8f !important;
            color: white !important;
        }

        .question-box {
            margin-bottom: 30px;
        }
        .question-label {
            display: inline-block;
            background-color: #e8f0fe;
            color: #1a73e8;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .question-text {
            font-size: var(--question-font-size); 
            font-weight: bold;
            line-height: 1.6;
        }
        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .option-btn {
            padding: 16px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            font-size: var(--option-font-size); 
            color: #444;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            position: relative;
        }
        .option-btn:hover {
            background-color: #f8f9fa;
            border-color: #bbb;
        }
        .option-btn:active {
            transform: scale(0.98);
        }
        /* è¤‡æ•°é¸æŠæ™‚ã®é¸æŠçŠ¶æ…‹ */
        .option-btn.selected {
            border-color: #1a73e8;
            background-color: #e8f0fe;
            box-shadow: 0 0 5px rgba(26, 115, 232, 0.5);
        }

        /* æ­£è§£ãƒ»ä¸æ­£è§£æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .option-btn.correct {
            background-color: #e6fffa !important;
            border-color: #2a9d8f !important;
            color: #2a9d8f;
            font-weight: bold;
        }
        .option-btn.correct::after {
            content: "â—";
            position: absolute;
            right: 20px;
            font-size: 1.2rem;
        }
        .option-btn.wrong {
            background-color: #fff5f5 !important;
            border-color: #e76f51 !important;
            color: #e76f51;
        }
        .option-btn.wrong::after {
            content: "âœ•";
            position: absolute;
            right: 20px;
            font-size: 1.2rem;
        }

        /* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .result-area {
            margin-top: 25px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 12px;
            border-left: 5px solid #ccc;
            display: none; 
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .result-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
            display: block;
        }
        .explanation {
            font-size: 0.95rem;
            color: #555;
            line-height: 1.7;
        }
        .next-btn {
            display: block;
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #1a73e8, #0056b3);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            margin-top: 25px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(26, 115, 232, 0.3);
            transition: opacity 0.3s;
        }
        .next-btn:hover {
            opacity: 0.9;
        }
        /* åˆ¤å®šãƒœã‚¿ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .check-multi-btn {
            display: block;
            width: 100%;
            padding: 16px;
            background-color: #28a745; 
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            margin-top: 25px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(40, 167, 69, 0.3);
            transition: opacity 0.3s;
        }
        .check-multi-btn:hover {
            opacity: 0.9;
        }
        
        /* æˆç¸¾ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .dashboard {
            margin-top: 25px;
            padding: 20px;
            background-color: #e8f5e9; /* è–„ã„ç·‘è‰²ã§å­¦ç¿’é€²æ—ã‚’è¡¨ç¾ */
            border-radius: 12px;
            border: 1px solid #c8e6c9;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .dashboard h2 {
            font-size: 1.1rem;
            color: #388e3c; /* æ¿ƒã„ç·‘è‰² */
            border-bottom: 2px solid #a5d6a7;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }
        .score-summary {
            text-align: center;
            margin-bottom: 20px;
        }
        .score-summary p {
            font-size: 0.95rem;
            margin: 5px 0;
        }
        .score-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #388e3c;
            display: block;
            line-height: 1.1;
        }

        /* åˆ†é‡åˆ¥æ­£ç­”ç‡ãƒªã‚¹ãƒˆ */
        .category-scores {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 0.9rem;
        }
        .category-scores li {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #e0e0e0;
        }
        .category-scores li:last-child {
            border-bottom: none;
        }
        .category-scores .category-name {
            font-weight: 500;
        }
        .category-scores .rate {
            font-weight: bold;
            color: #1a73e8; /* é’è‰²ã§å¼·èª¿ */
        }

        /* ã‚¹ã‚³ã‚¢ãŒä½ã„å ´åˆã®è­¦å‘Šè‰² */
        .category-scores .rate.low {
            color: #e76f51; /* èµ¤ã‚ªãƒ¬ãƒ³ã‚¸è‰² */
        }
        
        /* --- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ (Media Query) --- */
        @media (max-width: 550px) {
            body {
                padding: 10px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¸›ã‚‰ã™ */
            }
            .card {
                padding: 20px 15px; /* ã‚«ãƒ¼ãƒ‰ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¸›ã‚‰ã™ */
                border-radius: 0; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯è§’ä¸¸ã‚’ãªãã™ */
                min-height: 100vh; /* ç”»é¢å…¨ä½“ã‚’ä½¿ã† */
            }
            h1 {
                margin-bottom: 20px;
            }
            
            /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ã®èª¿æ•´ */
            .category-controls, .mode-row {
                flex-direction: column; /* ç¸¦ã«ç©ã¿é‡ã­ã‚‹ */
                gap: 10px;
                align-items: stretch; /* å¹…ã‚’æƒãˆã‚‹ */
            }
            .category-controls label {
                text-align: left; /* ãƒ©ãƒ™ãƒ«ã‚’å·¦å¯„ã› */
            }
            
            .category-controls select,
            #review-mode-btn, 
            #reset-review-btn, 
            #quick-five-btn {
                width: 100%; /* ãƒ•ãƒ«å¹…ã«ã™ã‚‹ */
                box-sizing: border-box; 
            }
            
            /* æ–‡å­—ã‚µã‚¤ã‚ºã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å³ã«å¯„ã›ã‚‹ */
            .font-size-control {
                justify-content: flex-start; /* å·¦å¯„ã›ã«å¤‰æ›´ã—ã¦ã€ä»–ã®è¦ç´ ã¨æƒãˆã‚‹ */
                margin-top: 5px; /* ä¸Šéƒ¨ã«å°‘ã—ã‚¹ãƒšãƒ¼ã‚¹ */
            }
            .font-size-control label {
                flex-shrink: 0; /* ãƒ©ãƒ™ãƒ«ãŒç¸®ã¾ãªã„ã‚ˆã†ã« */
            }

            /* ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
            .option-btn {
                padding: 14px 16px;
                font-size: 0.9rem; /* ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ãƒ•ã‚©ãƒ³ãƒˆã‚’å°‘ã—å°ã•ã */
            }
            
            /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ */
            .dashboard {
                padding: 15px;
            }
            .score-value {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body onload="updateReviewButton(); initializeFontSize()">

    <div class="card">
        <h1>ğŸš‘ æ•‘æ€¥æ•‘å‘½å£«éŒ¬æˆè©¦é¨“å¯¾ç­–</h1>
        
        <div class="category-controls">
            <label for="category-select">è©¦é¨“ã‚’é¸æŠ:</label> 
            <select id="category-select" onchange="loadRandomQuestion()">
                </select>
            
            <label for="order-select">å‡ºé¡Œé †:</label>
            <select id="order-select" onchange="loadRandomQuestion()">
                <option value="random">ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆã‚¹ãƒãƒ¼ãƒˆï¼‰</option>
                <option value="sequential">IDé †</option>
            </select>
        </div>
        
        <div class="mode-controls">
            <div class="mode-row">
                <button id="review-mode-btn" onclick="toggleReviewMode()">
                    èª¤ç­”ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ (0å•)
                </button>
                <button id="reset-review-btn" onclick="resetIncorrectQuestions()">
                    å±¥æ­´ãƒªã‚»ãƒƒãƒˆ
                </button>
                
                <div class="font-size-control">
                    <label for="font-size-select">æ–‡å­—ã‚µã‚¤ã‚º:</label>
                    <select id="font-size-select" onchange="setFontSize(this.value)">
                        <option value="small">å°</option>
                        <option value="medium">ä¸­</option>
                        <option value="large">å¤§</option>
                    </select>
                </div>
            </div>
            
            <button id="quick-five-btn" onclick="startQuickFiveMode()">
                ã‚µã‚¯ã‚µã‚¯5å•ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹
            </button>
        </div>

        <div id="quiz-container">
            <div class="question-box">
                <span class="question-label">å•é¡Œ</span>
                <div class="question-text" id="question">
                    èª­ã¿è¾¼ã¿ä¸­...
                </div>
            </div>
            
            <div class="options" id="options">
                </div>
        </div>

        <div class="result-area" id="result">
            <span class="result-title" id="result-title"></span>
            <div class="explanation">
                <strong>ã€è§£èª¬ã€‘</strong><br>
                <span id="explanation-text"></span>
            </div>
            <button class="next-btn" onclick="loadRandomQuestion()">æ¬¡ã®å•é¡Œã¸</button>
        </div>
        
        <div class="dashboard" id="score-dashboard">
            <h2>ğŸ“Š å­¦ç¿’é€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
            
            <div class="score-summary">
                <p>ç·åˆæ­£ç­”ç‡</p>
                <span id="overall-rate" class="score-value">--%</span>
                <p>ï¼ˆåˆè¨ˆ <span id="overall-total">--</span> å•ï¼‰</p>
            </div>
            
            <h3>è©¦é¨“åˆ¥æ­£ç­”ç‡</h3>
            <ul class="category-scores" id="category-score-list">
                <li>è¨ˆç®—ä¸­...</li>
            </ul>
        </div>
        
    </div>

    <script src="questions.js"></script>

    <script>
        // --- ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ã¨ç®¡ç† ---
        const INCORRECT_KEY = 'incorrectQuestionIds';
        const HISTORY_KEY = 'questionHistory'; 
        const FONT_SIZE_KEY = 'appFontSize'; 
        let reviewMode = false;
        let availableCategories = []; 
        let currentSequentialIndex = 0; 

        // 5å•ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ç®¡ç†
        let quickFiveMode = false;
        let quickFiveQuestions = []; // å‡ºé¡Œäºˆå®šã®å•é¡ŒIDãƒªã‚¹ãƒˆ
        let quickFiveIndex = 0;      // ç¾åœ¨ã®å•é¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        let quickFiveResults = []; // 5å•ãƒ¢ãƒ¼ãƒ‰ã®çµæœã‚’ä¿å­˜ã™ã‚‹é…åˆ—

        function getIncorrectQuestions() {
            const stored = localStorage.getItem(INCORRECT_KEY);
            return stored ? JSON.parse(stored) : [];
        }

        function saveIncorrectQuestions(incorrectIds) {
            localStorage.setItem(INCORRECT_KEY, JSON.stringify(incorrectIds));
            updateReviewButton(); 
        }

        function addIncorrectQuestion(id) {
            let incorrectIds = getIncorrectQuestions();
            if (!incorrectIds.includes(id)) {
                incorrectIds.push(id);
                saveIncorrectQuestions(incorrectIds);
            }
        }

        function removeIncorrectQuestion(id) {
            let incorrectIds = getIncorrectQuestions();
            const index = incorrectIds.indexOf(id);
            if (index > -1) {
                incorrectIds.splice(index, 1);
                saveIncorrectQuestions(incorrectIds);
            }
        }
        
        // --- å•é¡Œã®å­¦ç¿’å±¥æ­´ç®¡ç† ---
        function getQuestionHistory() {
            const stored = localStorage.getItem(HISTORY_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        function updateQuestionHistory(id, isCorrect) {
            const history = getQuestionHistory();
            const current = history[id] || { total: 0, correct: 0, lastCorrect: 0 }; 
            
            current.total++;
            
            if (isCorrect) {
                current.correct++;
                current.lastCorrect = Date.now(); 
                removeIncorrectQuestion(id); 
            } else {
                addIncorrectQuestion(id); 
            }
            
            history[id] = current;
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            updateReviewButton();
            updateScoreDashboard(); 
        }
        
        // --- ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºç®¡ç†æ©Ÿèƒ½ ---
        const FONT_SIZES = {
            small: { question: '0.9rem', option: '0.85rem' },
            medium: { question: '1.05rem', option: '0.95rem' }, 
            large: { question: '1.2rem', option: '1.1rem' }
        };

        function getFontSizeSetting() {
            return localStorage.getItem(FONT_SIZE_KEY) || 'medium'; 
        }

        function setFontSize(size) {
            if (!FONT_SIZES[size]) return;

            // 1. CSSå¤‰æ•°ã‚’è¨­å®šï¼ˆå‹•çš„ã«ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å¤‰æ›´ï¼‰
            document.documentElement.style.setProperty('--question-font-size', FONT_SIZES[size].question);
            document.documentElement.style.setProperty('--option-font-size', FONT_SIZES[size].option);

            // 2. è¨­å®šã‚’ä¿å­˜
            localStorage.setItem(FONT_SIZE_KEY, size);
            
            // 3. ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®è¡¨ç¤ºã‚’åŒæœŸ
            const select = document.getElementById('font-size-select');
            if (select) {
                select.value = size;
            }
        }

        function initializeFontSize() {
            const savedSize = getFontSizeSetting();
            setFontSize(savedSize);
        }
        // ------------------------------------
        
        // --- æˆç¸¾è¨ˆç®—ãƒ»è¡¨ç¤ºæ©Ÿèƒ½ ---

        function calculateScores() {
            const history = getQuestionHistory();
            let totalQuestions = 0;
            let totalCorrect = 0;
            const categoryStats = {}; // { 'ã‚«ãƒ†ã‚´ãƒªãƒ¼å': { total: 0, correct: 0 } }
            
            // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒªã‚¹ãƒˆã‚’æº–å‚™ï¼ˆè¨­å®šã•ã‚Œã¦ã„ãªã„å•é¡Œã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
            const questionsByCategory = questionData.reduce((acc, q) => {
                if (q.category) {
                    if (!acc[q.category]) {
                        acc[q.category] = [];
                    }
                    acc[q.category].push(q);
                }
                return acc;
            }, {});
            
            // 1. å…¨å•é¡Œã®çµ±è¨ˆã‚’è¨ˆç®—
            for (const id in history) {
                const h = history[id];
                totalQuestions += h.total;
                totalCorrect += h.correct;
                
                // 2. åˆ†é‡åˆ¥ã®çµ±è¨ˆã‚‚åŒæ™‚ã«è¨ˆç®—
                const q = questionData.find(q => q.id == id);
                if (q && q.category) {
                    const category = q.category;
                    if (!categoryStats[category]) {
                        categoryStats[category] = { total: 0, correct: 0 };
                    }
                    categoryStats[category].total += h.total;
                    categoryStats[category].correct += h.correct;
                }
            }
            
            // 3. æœªå›ç­”ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’0%ã§ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆæœªå›ç­”ã§ã‚‚è¡¨ç¤ºã™ã‚‹ãŸã‚ï¼‰
            for (const category in questionsByCategory) {
                if (!categoryStats[category]) {
                    categoryStats[category] = { total: 0, correct: 0 };
                }
            }
            
            return { totalQuestions, totalCorrect, categoryStats };
        }


        function updateScoreDashboard() {
            const { totalQuestions, totalCorrect, categoryStats } = calculateScores();
            
            const overallRateElement = document.getElementById('overall-rate');
            const overallTotalElement = document.getElementById('overall-total');
            const categoryListElement = document.getElementById('category-score-list');
            
            // ç·åˆæ­£ç­”ç‡ã®è¡¨ç¤º
            const overallRate = totalQuestions > 0 ? ((totalCorrect / totalQuestions) * 100).toFixed(1) : 0;
            overallRateElement.innerText = `${overallRate}%`;
            overallTotalElement.innerText = totalQuestions;
            
            // åˆ†é‡åˆ¥æ­£ç­”ç‡ã®è¡¨ç¤º
            categoryListElement.innerHTML = '';
            
            const sortedCategories = Object.keys(categoryStats).sort();

            sortedCategories.forEach(category => {
                const stats = categoryStats[category];
                const categoryTotal = stats.total;
                const categoryCorrect = stats.correct;
                
                const rate = categoryTotal > 0 ? ((categoryCorrect / categoryTotal) * 100).toFixed(1) : 0;
                
                const listItem = document.createElement('li');
                
                let rateClass = '';
                // 5å•ä»¥ä¸Šå›ç­”ã‹ã¤æ­£ç­”ç‡60%æœªæº€ã§è­¦å‘Š
                if (categoryTotal > 4 && rate < 60) { 
                     rateClass = 'low';
                }

                // ã‚«ãƒ†ã‚´ãƒªãƒ¼åã‚’ãã®ã¾ã¾ã€Œè©¦é¨“åã€ã¨ã—ã¦ä½¿ç”¨
                listItem.innerHTML = `
                    <span class="category-name">${category}</span>
                    <span class="rate ${rateClass}">
                        ${rate}%
                        <span style="font-size:0.8em; color:#777; margin-left:8px;">
                            (${categoryCorrect}/${categoryTotal})
                        </span>
                    </span>
                `;
                categoryListElement.appendChild(listItem);
            });
        }
        
        // --- UIã¨ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡ ---
        function setupCategories() {
            if (typeof questionData === 'undefined') return;

            const categories = questionData.map(q => q.category).filter(Boolean);
            availableCategories = [...new Set(categories)].sort(); 
            
            const select = document.getElementById('category-select');
            select.innerHTML = ''; 

            const allOption = document.createElement('option');
            allOption.value = 'all';
            // å…¨ã¦ã®è©¦é¨“ã«ä¿®æ­£æ¸ˆã¿
            allOption.innerText = 'å…¨ã¦ã®è©¦é¨“';
            select.appendChild(allOption);

            availableCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.innerText = category;
                select.appendChild(option);
            });
        }

        function updateReviewButton() {
            const incorrectIds = getIncorrectQuestions();
            const count = incorrectIds.length;
            const btn = document.getElementById('review-mode-btn');

            if (btn) {
                btn.innerText = `èª¤ç­”ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ (${count}å•)`;
                
                if (count === 0 && !reviewMode) {
                    btn.disabled = true;
                } else {
                    btn.disabled = false;
                }
                
                if (reviewMode) {
                    btn.style.backgroundColor = '#e76f51';
                    btn.style.color = 'white';
                    if (count === 0) {
                        toggleReviewMode();
                    }
                } else {
                    btn.style.backgroundColor = 'white';
                    btn.style.color = '#e76f51';
                }
            }
        }
        
        function resetIncorrectQuestions() {
            if (confirm("æœ¬å½“ã«èª¤ç­”ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å±¥æ­´ã¨å­¦ç¿’å±¥æ­´ã‚’å…¨ã¦ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚")) {
                localStorage.removeItem(INCORRECT_KEY);
                localStorage.removeItem(HISTORY_KEY); 
                reviewMode = false;
                currentSequentialIndex = 0; 
                endQuickFiveMode(false); // 5å•ãƒ¢ãƒ¼ãƒ‰ã‚’å¼·åˆ¶çµ‚äº† (çµæœè¡¨ç¤ºãªã—)
                updateReviewButton();
                loadRandomQuestion();
                updateScoreDashboard(); 
                alert("èª¤ç­”ãƒ¬ãƒ“ãƒ¥ãƒ¼å±¥æ­´ã¨å­¦ç¿’å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
            }
        }

        function toggleReviewMode() {
            const incorrectIds = getIncorrectQuestions();
            
            if (!reviewMode) {
                if (incorrectIds.length === 0) {
                    alert('ç¾åœ¨ã€èª¤ç­”å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }
                reviewMode = true;
                endQuickFiveMode(false); // 5å•ãƒ¢ãƒ¼ãƒ‰ã‚’å¼·åˆ¶çµ‚äº† (çµæœè¡¨ç¤ºãªã—)
                alert(`èª¤ç­”ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™ã€‚é–“é•ãˆãŸ ${incorrectIds.length} å•ã‹ã‚‰å‡ºé¡Œã—ã¾ã™ã€‚`);
            } else {
                reviewMode = false;
                alert('é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã™ã€‚');
            }
            updateReviewButton();
            loadRandomQuestion();
        }

        // 5å•ãƒ¢ãƒ¼ãƒ‰ã®é–‹å§‹
        function startQuickFiveMode() {
            if (typeof questionData === 'undefined' || questionData.length === 0) {
                 alert("å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                 return;
            }

            quickFiveMode = true;
            quickFiveQuestions = [];
            quickFiveIndex = 0;
            quickFiveResults = []; 

            // ä»–ã®ãƒ¢ãƒ¼ãƒ‰ã‚’å¼·åˆ¶çµ‚äº†
            reviewMode = false;
            updateReviewButton();

            // å…¨å•é¡ŒIDã‚’å–å¾—ã—ã€å®Œå…¨ã«ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            let allIds = questionData.map(q => q.id);
            // Fisher-Yates shuffle
            for (let i = allIds.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allIds[i], allIds[j]] = [allIds[j], allIds[i]];
            }

            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã•ã‚ŒãŸãƒªã‚¹ãƒˆã‹ã‚‰æœ€åˆã®5å•ã‚’é¸æŠ
            quickFiveQuestions = allIds.slice(0, 5);
            
            // UIã‚’æ›´æ–°
            document.getElementById('quick-five-btn').style.backgroundColor = '#2a9d8f';
            document.getElementById('quick-five-btn').style.color = 'white';
            document.getElementById('quick-five-btn').innerText = `ã‚µã‚¯ã‚µã‚¯5å•ãƒ¢ãƒ¼ãƒ‰ (1 / 5)`;
            
            // ä»–ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
            document.getElementById('review-mode-btn').disabled = true;
            document.getElementById('category-select').disabled = true;
            document.getElementById('order-select').disabled = true;
            
            // å•é¡Œã‚¨ãƒªã‚¢ã‚’å†è¡¨ç¤ºï¼ˆå‰ã®çµæœãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚ï¼‰
            document.getElementById('quiz-container').style.display = 'block';

            // 1å•ç›®ã‚’ãƒ­ãƒ¼ãƒ‰
            loadRandomQuestion();
        }

        // 5å•ãƒ¢ãƒ¼ãƒ‰ã®çµ‚äº† (showResult: çµæœã‚’è¡¨ç¤ºã™ã‚‹ã‹ã©ã†ã‹)
        function endQuickFiveMode(showResult = true) {
            
            // çµæœè¡¨ç¤º
            if (showResult) {
                // çµæœã®é›†è¨ˆ
                const total = quickFiveResults.length;
                const correctCount = quickFiveResults.filter(r => r.isCorrect).length;
                const rate = total > 0 ? ((correctCount / total) * 100).toFixed(1) : 0;
                
                // UIè¦ç´ ã‚’å–å¾—
                const resultArea = document.getElementById('result');
                const resultTitle = document.getElementById('result-title');
                const explanationSpan = document.getElementById('explanation-text');
                const nextBtn = document.querySelector('.next-btn');

                // å•é¡Œã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
                document.getElementById('quiz-container').style.display = 'none';

                resultTitle.innerText = "âœ¨ ã‚µã‚¯ã‚µã‚¯5å•ãƒ¢ãƒ¼ãƒ‰çµ‚äº†ï¼";
                resultTitle.style.color = "#1a73e8";
                resultArea.style.borderLeftColor = "#1a73e8";

                // çµæœã®ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆ
                let summaryHtml = `
                    <h3>ã€çµæœã‚µãƒãƒªãƒ¼ã€‘</h3>
                    <p style="font-size:1.5rem; font-weight:bold; color:#1a73e8;">
                        ${correctCount} / ${total} å•æ­£è§£ ï¼ˆæ­£ç­”ç‡: ${rate}%ï¼‰
                    </p>
                    <p style="margin-top:20px;">
                        æ¬¡ã®å•é¡Œã¸é€²ã‚€ã¨ã€é€šå¸¸ã®ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã™ã€‚
                    </p>
                `;

                explanationSpan.innerHTML = summaryHtml;
                nextBtn.innerText = 'é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã¸æˆ»ã‚‹';
                
                // æ¬¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‹•ä½œï¼šå•é¡Œã‚¨ãƒªã‚¢ã‚’å†è¡¨ç¤ºã—ã€é€šå¸¸ã®å•é¡Œã‚’ãƒ­ãƒ¼ãƒ‰
                nextBtn.onclick = () => {
                    document.getElementById('quiz-container').style.display = 'block';
                    // loadRandomQuestionã‚’å‘¼ã¶å‰ã«resultAreaã‚’éš ã™
                    document.getElementById('result').style.display = 'none'; 
                    loadRandomQuestion();
                };

                resultArea.style.display = 'block';
                
                alert(`ã‚µã‚¯ã‚µã‚¯5å•ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚${correctCount}/${total} å•æ­£è§£ã§ã™ï¼`);
            } else {
                // çµæœè¡¨ç¤ºã‚’ã—ãªã„å ´åˆã€resultAreaã‚’éš ã™
                document.getElementById('result').style.display = 'none';
                document.getElementById('quiz-container').style.display = 'block';
            }

            // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            quickFiveMode = false;
            quickFiveQuestions = [];
            quickFiveIndex = 0;
            quickFiveResults = [];

            // UIã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('quick-five-btn').style.backgroundColor = 'white';
            document.getElementById('quick-five-btn').style.color = '#2a9d8f';
            document.getElementById('quick-five-btn').innerText = `ã‚µã‚¯ã‚µã‚¯5å•ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹`;
            
            document.getElementById('review-mode-btn').disabled = false;
            document.getElementById('category-select').disabled = false;
            document.getElementById('order-select').disabled = false;
        }

        // --- å•é¡Œã®èª­ã¿è¾¼ã¿ãƒ­ã‚¸ãƒƒã‚¯ (ã‚¹ãƒãƒ¼ãƒˆå‡ºé¡Œã«å¯¾å¿œ) ---
        let currentQuestion = null;

        if (typeof questionData === 'undefined') {
            alert("ã‚¨ãƒ©ãƒ¼ï¼š'questions.js' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            document.getElementById('question').innerText = "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        }

        function loadRandomQuestion() {
            // çµæœã‚¨ãƒªã‚¢ã‚’éš ã—ã¦ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('result').style.display = 'none';
            document.getElementById('options').innerHTML = '';
            
            let q;
            let candidateQuestions = [];
            const incorrectIds = getIncorrectQuestions();
            
            const categorySelect = document.getElementById('category-select');
            const orderSelect = document.getElementById('order-select'); 
            
            const selectedCategory = categorySelect ? categorySelect.value : 'all';
            const selectedOrder = orderSelect ? orderSelect.value : 'random'; 

            // 1. ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§å•é¡Œãƒªã‚¹ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredQuestions = questionData.filter(q => {
                return selectedCategory === 'all' || q.category === selectedCategory;
            });
            
            // IDé †ã«ä¸¦ã¹æ›¿ãˆã¦ãŠã
            filteredQuestions.sort((a, b) => a.id - b.id);

            // 5å•ãƒ¢ãƒ¼ãƒ‰ã®åˆ†å²
            if (quickFiveMode) {
                if (quickFiveIndex >= quickFiveQuestions.length) {
                    endQuickFiveMode(true); // æœ€å¾Œã®å•é¡Œã¾ã§è§£ç­”ã—ãŸã‚‰çµæœã‚’è¡¨ç¤ºã—ã¦çµ‚äº†
                    return;
                }

                // 5å•ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€æŒ‡å®šã•ã‚ŒãŸIDã®å•é¡Œã‚’ç‰¹å®š
                const questionId = quickFiveQuestions[quickFiveIndex];
                q = questionData.find(question => question.id === questionId);
                
                if (!q) {
                    console.error(`Error: Question ID ${questionId} not found.`);
                    endQuickFiveMode(false);
                    loadRandomQuestion();
                    return;
                }
            }
            // 5å•ãƒ¢ãƒ¼ãƒ‰ã§ãªã‘ã‚Œã°ã€æ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶™ç¶š
            else if (reviewMode && incorrectIds.length > 0) {
                // 2-1. ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰: ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸä¸­ã‹ã‚‰ã€èª¤ç­”ãƒªã‚¹ãƒˆã«ã‚ã‚‹å•é¡Œã®ã¿ã‚’é¸å‡º
                candidateQuestions = filteredQuestions.filter(q => incorrectIds.includes(q.id));
                
                if (candidateQuestions.length === 0) {
                    alert(`é¸æŠä¸­ã®è©¦é¨“ï¼ˆ${selectedCategory}ï¼‰ã«ã¯ã€èª¤ç­”ã—ãŸå•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã™ã€‚`);
                    toggleReviewMode();
                    return;
                }
                
                // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œ
                const randomIndex = Math.floor(Math.random() * candidateQuestions.length);
                q = candidateQuestions[randomIndex];

            } else if (selectedOrder === 'sequential') {
                // 2-2. IDé †ãƒ¢ãƒ¼ãƒ‰
                candidateQuestions = filteredQuestions;

                if (currentSequentialIndex >= candidateQuestions.length) {
                    currentSequentialIndex = 0; // å…¨å•è§£ãçµ‚ã‚ã£ãŸã‚‰æœ€åˆã«æˆ»ã‚‹
                    alert(`å…¨ ${candidateQuestions.length} å•ã‚’è§£ãçµ‚ã‚ã‚Šã¾ã—ãŸã€‚æœ€åˆã«æˆ»ã‚Šã¾ã™ã€‚`);
                }
                q = candidateQuestions[currentSequentialIndex];
                currentSequentialIndex++; // æ¬¡ã«å‚™ãˆã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é€²ã‚ã‚‹

            } else {
                // 2-3. ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚¹ãƒãƒ¼ãƒˆå‡ºé¡Œãƒ­ã‚¸ãƒƒã‚¯ã‚’é©ç”¨ï¼‰
                candidateQuestions = filteredQuestions;

                // å±¥æ­´ã‚’å–å¾—
                const history = getQuestionHistory();
                const now = Date.now();
                
                // å„å•é¡Œã«é‡ã¿ï¼ˆweightï¼‰ã‚’è¨ˆç®—
                const weightedQuestions = candidateQuestions.map(q => {
                    const h = history[q.id];
                    let weight = 1.0; // åŸºæœ¬ã®é‡ã¿
                    
                    if (h && h.total > 0) {
                        // â‘  æ­£ç­”ç‡ãŒä½ã„ã»ã©é‡ã¿ã‚’å¢—ã‚„ã™
                        const successRate = h.correct / h.total;
                        // æ­£ç­”ç‡ãŒ50%ãªã‚‰é‡ã¿1å€ã€0%ãªã‚‰é‡ã¿2å€ã«è¿‘ã¥ã
                        weight *= (2.0 - successRate); 
                        
                        // â‘¡ æœ€å¾Œã«æ­£è§£ã—ã¦ã‹ã‚‰æ™‚é–“ãŒçµŒã¤ã»ã©é‡ã¿ã‚’å¢—ã‚„ã™
                        const timeSinceCorrect = now - h.lastCorrect; // ãƒŸãƒªç§’
                        // 1æ—¥ä»¥ä¸Šæ­£è§£ãŒãªã„å ´åˆã«é‡ã¿ã‚’å¢—åŠ ã•ã›ã‚‹
                        const daysSinceCorrect = timeSinceCorrect / (1000 * 60 * 60 * 24); 
                        
                        // 1æ—¥çµŒéã”ã¨ã«é‡ã¿ãŒæœ€å¤§1.5å€ã¾ã§å¢—ãˆã‚‹ï¼ˆèª¿æ•´å¯èƒ½ï¼‰
                        if (daysSinceCorrect > 0) {
                            weight *= Math.min(1.5, 1 + (daysSinceCorrect * 0.1));
                        }
                    } else {
                        // æœªå›ç­”ã®å•é¡Œã¯é‡ã¿ã‚’é«˜ãè¨­å®šã—ã€å„ªå…ˆçš„ã«å‡ºé¡Œã™ã‚‹
                        weight = 3.0; 
                    }
                    
                    return { question: q, weight: weight };
                });

                // é‡ã¿ã®åˆè¨ˆã‚’è¨ˆç®—
                const totalWeight = weightedQuestions.reduce((sum, item) => sum + item.weight, 0);
                
                // ãƒ©ãƒ³ãƒ€ãƒ ãªé–¾å€¤ã‚’æ±ºå®š
                let randomThreshold = Math.random() * totalWeight;
                
                // é‡ã¿ä»˜ãæŠ½é¸ã‚’å®Ÿè¡Œ
                for (const item of weightedQuestions) {
                    randomThreshold -= item.weight;
                    if (randomThreshold <= 0) {
                        q = item.question;
                        break;
                    }
                }
                
                // ä¸‡ãŒä¸€æŠ½é¸ã«å¤±æ•—ã—ãŸã‚‰ã€é€šå¸¸ã®ãƒ©ãƒ³ãƒ€ãƒ é¸æŠã«æˆ»ã‚‹
                if (!q) {
                    const randomIndex = Math.floor(Math.random() * candidateQuestions.length);
                    q = candidateQuestions[randomIndex];
                }
            }


            if (candidateQuestions.length === 0 && !quickFiveMode) {
                document.getElementById('question').innerText = `ã‚¨ãƒ©ãƒ¼: é¸æŠã•ã‚ŒãŸè©¦é¨“ï¼ˆ${selectedCategory}ï¼‰ã«å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚questions.jsã«ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
                document.querySelector('.question-label').innerText = 'å•é¡Œãªã—';
                return;
            }

            currentQuestion = q; 

            // å•é¡Œæ–‡ã‚’è¡¨ç¤º
            let modeLabel = quickFiveMode ? "ï¼ˆ5å•ä¸­ï¼‰" : (reviewMode ? "ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ï¼‰" : "");
            let categoryInfo = selectedCategory !== 'all' && !quickFiveMode ? ` [${selectedCategory}]` : "";
            let orderInfo;
            
            if (quickFiveMode) {
                orderInfo = ` (${quickFiveIndex + 1} / ${quickFiveQuestions.length})`;
            } else if (selectedOrder === 'sequential' && !reviewMode) {
                orderInfo = ` (ID:${q.id}, ${currentSequentialIndex}/${filteredQuestions.length})`; 
            } else {
                orderInfo = ` (ID:${q.id})`;
            }
            
            let label = q.isMultiSelect ? `å•é¡Œ${modeLabel}ï¼ˆè¤‡æ•°é¸æŠï¼‰` : `å•é¡Œ${modeLabel}ï¼ˆå˜ä¸€é¸æŠï¼‰`;
            document.querySelector('.question-label').innerText = label + categoryInfo + orderInfo; 
            document.getElementById('question').innerText = q.text;
            
            // é¸æŠè‚¢ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
            document.getElementById('quiz-container').style.display = 'block'; // å•é¡Œè¡¨ç¤ºæ™‚ã«å†è¡¨ç¤ºã‚’ç¢ºç´„
            q.options.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = option;

                // è¤‡æ•°é¸æŠå•é¡Œã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
                if (q.isMultiSelect) {
                    // è¤‡æ•°é¸æŠã®å ´åˆã€ã‚¯ãƒªãƒƒã‚¯ã§ã‚¯ãƒ©ã‚¹ã‚’ãƒˆã‚°ãƒ«ã™ã‚‹ã ã‘ï¼ˆåˆ¤å®šã¯ã—ãªã„ï¼‰
                    btn.onclick = () => {
                        btn.classList.toggle('selected');
                    };
                } else {
                    // å˜ä¸€é¸æŠã®å ´åˆã®ã¿ã€ã‚¯ãƒªãƒƒã‚¯ã§åˆ¤å®šé–¢æ•°ã‚’å‘¼ã¶
                    btn.onclick = () => checkSingleAnswer(index, q);
                }
                document.getElementById('options').appendChild(btn);
            });

            // åˆ¤å®šãƒœã‚¿ãƒ³ã®ç”Ÿæˆ
            if (q.isMultiSelect) {
                const checkBtn = document.createElement('button');
                checkBtn.className = 'check-multi-btn'; 
                checkBtn.innerText = 'è§£ç­”ã‚’åˆ¤å®šã™ã‚‹';
                checkBtn.onclick = () => checkMultiAnswer(checkBtn); 
                document.getElementById('options').appendChild(checkBtn);
            }
        }
        
        // --- åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---

        // å…±é€šã®æ¬¡ã¸é€²ã‚€å‡¦ç†
        function proceedToNextQuestion(q, isCorrect) {
            // å­¦ç¿’å±¥æ­´ã®æ›´æ–°
            updateQuestionHistory(q.id, isCorrect); 
            
            const nextBtn = document.querySelector('.next-btn');

            if (quickFiveMode) {
                // 5å•ãƒ¢ãƒ¼ãƒ‰ã®çµæœã‚’è¨˜éŒ²
                quickFiveResults.push({ id: q.id, isCorrect: isCorrect }); 
                
                quickFiveIndex++;
                // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
                if (quickFiveIndex < quickFiveQuestions.length) {
                    nextBtn.innerText = `æ¬¡ã®å•é¡Œï¼ˆ${quickFiveIndex + 1} / ${quickFiveQuestions.length}ï¼‰ã¸`;
                    document.getElementById('quick-five-btn').innerText = `ã‚µã‚¯ã‚µã‚¯5å•ãƒ¢ãƒ¼ãƒ‰ (${quickFiveIndex + 1} / ${quickFiveQuestions.length})`;
                } else {
                    nextBtn.innerText = `çµæœã‚’è¦‹ã‚‹`; // æœ€å¾Œã®å•é¡Œã®æ¬¡ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆ
                    document.getElementById('quick-five-btn').innerText = `5å•ãƒ¢ãƒ¼ãƒ‰çµ‚äº†`;
                }
                nextBtn.onclick = loadRandomQuestion; 
            } else {
                nextBtn.innerText = 'æ¬¡ã®å•é¡Œã¸';
                nextBtn.onclick = loadRandomQuestion;
            }
        }


        function checkSingleAnswer(selectedIndex, q) {
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(btn => btn.disabled = true); 

            const resultArea = document.getElementById('result');
            const resultTitle = document.getElementById('result-title');
            const explanationSpan = document.getElementById('explanation-text');
            
            const correctIndex = q.correctIndex; 
            const isCorrect = selectedIndex === correctIndex; 

            if (isCorrect) {
                buttons[selectedIndex].classList.add('correct');
                resultTitle.innerText = "â— æ­£è§£ï¼ç´ æ™´ã‚‰ã—ã„ï¼";
                resultTitle.style.color = "#2a9d8f";
                resultArea.style.borderLeftColor = "#2a9d8f";
            } else {
                buttons[selectedIndex].classList.add('wrong');
                if (correctIndex !== undefined && correctIndex >= 0 && correctIndex < buttons.length) {
                    buttons[correctIndex].classList.add('correct'); 
                }
                
                resultTitle.innerText = "âœ• æ®‹å¿µ... èª¤ç­”ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸã€‚";
                resultTitle.style.color = "#e76f51";
                resultArea.style.borderLeftColor = "#e76f51";
            }

            explanationSpan.innerHTML = q.explanation;
            resultArea.style.display = 'block';
            
            // å…±é€šã®æ¬¡ã¸é€²ã‚€å‡¦ç†
            proceedToNextQuestion(q, isCorrect); 
        }

        function checkMultiAnswer(clickedCheckBtn) {
            if (!currentQuestion || !currentQuestion.isMultiSelect) {
                console.error("ã‚¨ãƒ©ãƒ¼: ç¾åœ¨ã®å•é¡ŒãŒè¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }

            if (!currentQuestion.correctIndices || !Array.isArray(currentQuestion.correctIndices)) {
                // ã‚¨ãƒ©ãƒ¼å‡¦ç†
                const resultArea = document.getElementById('result');
                document.getElementById('result-title').innerText = "ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼: å•é¡Œã®æ­£è§£ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
                document.getElementById('result-title').style.color = "#ff4444";
                resultArea.style.borderLeftColor = "#ff4444";
                document.getElementById('explanation-text').innerHTML = "questions.js ã®å•é¡ŒID " + currentQuestion.id + " ã« **`correctIndices: [...]`** ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
                resultArea.style.display = 'block';
                document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
                clickedCheckBtn.disabled = true;
                return;
            }

            const buttons = document.querySelectorAll('.option-btn');
            const selectedIndices = [];
            buttons.forEach((btn, index) => {
                if (btn.classList.contains('selected')) {
                    selectedIndices.push(index);
                }
            });

            const correct = currentQuestion.correctIndices.sort((a, b) => a - b).toString();
            const userSelected = selectedIndices.sort((a, b) => a - b).toString();

            const isCorrect = correct === userSelected;

            buttons.forEach(btn => btn.disabled = true);
            clickedCheckBtn.disabled = true; 

            const resultArea = document.getElementById('result');
            const resultTitle = document.getElementById('result-title');
            const explanationSpan = document.getElementById('explanation-text');
            
            if (isCorrect) {
                resultTitle.innerText = "â— å®Œå…¨æ­£è§£ï¼";
                resultTitle.style.color = "#2a9d8f";
                resultArea.style.borderLeftColor = "#2a9d8f";
            } else {
                resultTitle.innerText = "âœ• ä¸æ­£è§£... èª¤ç­”ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸã€‚";
                resultTitle.style.color = "#e76f51";
                resultArea.style.borderLeftColor = "#e76f51";
            }

            buttons.forEach((btn, index) => {
                const isUserSelected = selectedIndices.includes(index);
                const isActuallyCorrect = currentQuestion.correctIndices.includes(index);
                
                if (isActuallyCorrect) {
                    btn.classList.add('correct'); 
                } else if (isUserSelected) {
                    btn.classList.add('wrong'); 
                }
            });

            explanationSpan.innerHTML = currentQuestion.explanation;
            resultArea.style.display = 'block';

            // å…±é€šã®æ¬¡ã¸é€²ã‚€å‡¦ç†
            proceedToNextQuestion(currentQuestion, isCorrect);
        }


        // ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸã¨ãã«æœ€åˆã®å•é¡Œã‚’å‡ºã—ã€ãƒœã‚¿ãƒ³ã®æ•°ã‚’æ›´æ–°
        if (typeof questionData !== 'undefined') {
            setupCategories(); 
            loadRandomQuestion();
            updateReviewButton();
            initializeFontSize();
            updateScoreDashboard(); 
        }
    </script>
</body>
</html>
