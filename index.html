<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•‘æ€¥æ•‘å‘½å£« å›½å®¶è©¦é¨“å¯¾ç­– Webã‚¢ãƒ—ãƒª</title>
    <style>
        /* --- ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š (CSS) --- */
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .card {
            background: white;
            width: 100%;
            max-width: 600px;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }
        h1 {
            font-size: 1.2rem;
            color: #1a73e8;
            text-align: center;
            margin-bottom: 25px;
            font-weight: 700;
            letter-spacing: 0.05em;
        }
        
        /* ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨å‡ºé¡Œé †ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’ã¾ã¨ã‚ã‚‹ */
        .category-controls {
            margin-bottom: 15px; 
            text-align: center;
            display: flex;
            justify-content: center;
            flex-wrap: wrap; 
            gap: 15px;
        }
        .category-controls label, .category-controls select {
            font-size: 1rem;
        }
        .category-controls select {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        .mode-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }
        #review-mode-btn {
            padding: 10px 20px;
            border: 2px solid #e76f51; 
            background: white; 
            color: #e76f51; 
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        #review-mode-btn[style*="background-color: rgb(231, 111, 81)"] {
            background-color: #e76f51 !important;
            color: white !important;
        }
        #reset-review-btn {
            padding: 10px 15px;
            border: 2px solid #ccc; 
            background: #f4f4f4; 
            color: #777; 
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 10px;
            font-size: 0.9rem;
        }

        .question-box {
            margin-bottom: 30px;
        }
        .question-label {
            display: inline-block;
            background-color: #e8f0fe;
            color: #1a73e8;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .question-text {
            font-size: 1.05rem; /* â˜…ä¿®æ­£: å•é¡Œæ–‡ã‚’å°ã•ã */
            font-weight: bold;
            line-height: 1.6;
        }
        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .option-btn {
            padding: 16px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            font-size: 0.95rem; /* â˜…ä¿®æ­£: é¸æŠè‚¢ã‚’å°ã•ã */
            color: #444;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            position: relative;
        }
        .option-btn:hover {
            background-color: #f8f9fa;
            border-color: #bbb;
        }
        .option-btn:active {
            transform: scale(0.98);
        }
        /* è¤‡æ•°é¸æŠæ™‚ã®é¸æŠçŠ¶æ…‹ */
        .option-btn.selected {
            border-color: #1a73e8;
            background-color: #e8f0fe;
            box-shadow: 0 0 5px rgba(26, 115, 232, 0.5);
        }

        /* æ­£è§£ãƒ»ä¸æ­£è§£æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .option-btn.correct {
            background-color: #e6fffa !important;
            border-color: #2a9d8f !important;
            color: #2a9d8f;
            font-weight: bold;
        }
        .option-btn.correct::after {
            content: "â—";
            position: absolute;
            right: 20px;
            font-size: 1.2rem;
        }
        .option-btn.wrong {
            background-color: #fff5f5 !important;
            border-color: #e76f51 !important;
            color: #e76f51;
        }
        .option-btn.wrong::after {
            content: "âœ•";
            position: absolute;
            right: 20px;
            font-size: 1.2rem;
        }

        /* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .result-area {
            margin-top: 25px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 12px;
            border-left: 5px solid #ccc;
            display: none; 
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .result-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
            display: block;
        }
        .explanation {
            font-size: 0.95rem;
            color: #555;
            line-height: 1.7;
        }
        .next-btn {
            display: block;
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #1a73e8, #0056b3);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            margin-top: 25px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(26, 115, 232, 0.3);
            transition: opacity 0.3s;
        }
        .next-btn:hover {
            opacity: 0.9;
        }
        /* åˆ¤å®šãƒœã‚¿ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .check-multi-btn {
            display: block;
            width: 100%;
            padding: 16px;
            background-color: #28a745; 
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            margin-top: 25px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(40, 167, 69, 0.3);
            transition: opacity 0.3s;
        }
        .check-multi-btn:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body onload="updateReviewButton()">

    <div class="card">
        <h1>ğŸš‘ æ•‘æ€¥æ•‘å‘½å£« å›½å®¶è©¦é¨“å¯¾ç­–</h1>
        
        <div class="category-controls">
            <label for="category-select">åˆ†é‡ã‚’é¸æŠ:</label>
            <select id="category-select" onchange="loadRandomQuestion()">
                </select>
            
            <label for="order-select">å‡ºé¡Œé †:</label>
            <select id="order-select" onchange="loadRandomQuestion()">
                <option value="random">ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆã‚¹ãƒãƒ¼ãƒˆï¼‰</option>
                <option value="sequential">IDé †</option>
            </select>
        </div>
        
        <div class="mode-controls">
            <button id="review-mode-btn" onclick="toggleReviewMode()">
                èª¤ç­”ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ (0å•)
            </button>
            <button id="reset-review-btn" onclick="resetIncorrectQuestions()">
                å±¥æ­´ãƒªã‚»ãƒƒãƒˆ
            </button>
        </div>

        <div id="quiz-container">
            <div class="question-box">
                <span class="question-label">å•é¡Œ</span>
                <div class="question-text" id="question">
                    èª­ã¿è¾¼ã¿ä¸­...
                </div>
            </div>
            
            <div class="options" id="options">
                </div>
        </div>

        <div class="result-area" id="result">
            <span class="result-title" id="result-title"></span>
            <div class="explanation">
                <strong>ã€è§£èª¬ã€‘</strong><br>
                <span id="explanation-text"></span>
            </div>
            <button class="next-btn" onclick="loadRandomQuestion()">æ¬¡ã®å•é¡Œã¸</button>
        </div>
    </div>

    <script src="questions.js"></script>

    <script>
        // --- ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ã¨ç®¡ç† ---
        const INCORRECT_KEY = 'incorrectQuestionIds';
        const HISTORY_KEY = 'questionHistory'; // å­¦ç¿’å±¥æ­´ã‚­ãƒ¼
        let reviewMode = false;
        let availableCategories = []; 
        let currentSequentialIndex = 0; // IDé †å‡ºé¡Œã®ãŸã‚ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

        function getIncorrectQuestions() {
            const stored = localStorage.getItem(INCORRECT_KEY);
            return stored ? JSON.parse(stored) : [];
        }

        function saveIncorrectQuestions(incorrectIds) {
            localStorage.setItem(INCORRECT_KEY, JSON.stringify(incorrectIds));
            updateReviewButton(); 
        }

        function addIncorrectQuestion(id) {
            let incorrectIds = getIncorrectQuestions();
            if (!incorrectIds.includes(id)) {
                incorrectIds.push(id);
                saveIncorrectQuestions(incorrectIds);
            }
        }

        function removeIncorrectQuestion(id) {
            let incorrectIds = getIncorrectQuestions();
            const index = incorrectIds.indexOf(id);
            if (index > -1) {
                incorrectIds.splice(index, 1);
                saveIncorrectQuestions(incorrectIds);
            }
        }
        
        // --- å•é¡Œã®å­¦ç¿’å±¥æ­´ç®¡ç† ---
        function getQuestionHistory() {
            const stored = localStorage.getItem(HISTORY_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        function updateQuestionHistory(id, isCorrect) {
            const history = getQuestionHistory();
            // total:å›ç­”å›æ•°, correct:æ­£è§£å›æ•°, lastCorrect:æœ€çµ‚æ­£è§£æ—¥æ™‚(UNIXã‚¿ã‚¤ãƒ )
            const current = history[id] || { total: 0, correct: 0, lastCorrect: 0 }; 
            
            current.total++;
            
            if (isCorrect) {
                current.correct++;
                current.lastCorrect = Date.now(); 
                removeIncorrectQuestion(id); // æ­£è§£ã—ãŸã‚‰èª¤ç­”ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
            } else {
                // ä¸æ­£è§£ã®å ´åˆã¯ã€èª¤ç­”ãƒªã‚¹ãƒˆã«è¿½åŠ 
                addIncorrectQuestion(id); 
            }
            
            history[id] = current;
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            updateReviewButton();
        }
        // ------------------------------------
        
        // --- UIã¨ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡ ---
        function setupCategories() {
            if (typeof questionData === 'undefined') return;

            const categories = questionData.map(q => q.category).filter(Boolean);
            availableCategories = [...new Set(categories)].sort(); 
            
            const select = document.getElementById('category-select');
            select.innerHTML = ''; 

            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.innerText = 'å…¨ã¦ã®åˆ†é‡';
            select.appendChild(allOption);

            availableCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.innerText = category;
                select.appendChild(option);
            });
        }

        function updateReviewButton() {
            const incorrectIds = getIncorrectQuestions();
            const count = incorrectIds.length;
            const btn = document.getElementById('review-mode-btn');

            if (btn) {
                btn.innerText = `èª¤ç­”ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ (${count}å•)`;
                
                if (count === 0 && !reviewMode) {
                    btn.disabled = true;
                } else {
                    btn.disabled = false;
                }
                
                if (reviewMode) {
                    btn.style.backgroundColor = '#e76f51';
                    btn.style.color = 'white';
                    if (count === 0) {
                        toggleReviewMode();
                    }
                } else {
                    btn.style.backgroundColor = 'white';
                    btn.style.color = '#e76f51';
                }
            }
        }
        
        function resetIncorrectQuestions() {
            if (confirm("æœ¬å½“ã«èª¤ç­”ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å±¥æ­´ã¨å­¦ç¿’å±¥æ­´ã‚’å…¨ã¦ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚")) {
                localStorage.removeItem(INCORRECT_KEY);
                localStorage.removeItem(HISTORY_KEY); 
                reviewMode = false;
                currentSequentialIndex = 0; 
                updateReviewButton();
                loadRandomQuestion();
                alert("èª¤ç­”ãƒ¬ãƒ“ãƒ¥ãƒ¼å±¥æ­´ã¨å­¦ç¿’å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
            }
        }

        function toggleReviewMode() {
            const incorrectIds = getIncorrectQuestions();
            
            if (!reviewMode) {
                if (incorrectIds.length === 0) {
                    alert('ç¾åœ¨ã€èª¤ç­”å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }
                reviewMode = true;
                alert(`èª¤ç­”ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™ã€‚é–“é•ãˆãŸ ${incorrectIds.length} å•ã‹ã‚‰å‡ºé¡Œã—ã¾ã™ã€‚`);
            } else {
                reviewMode = false;
                alert('é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã™ã€‚');
            }
            updateReviewButton();
            loadRandomQuestion();
        }

        // --- å•é¡Œã®èª­ã¿è¾¼ã¿ãƒ­ã‚¸ãƒƒã‚¯ (ã‚¹ãƒãƒ¼ãƒˆå‡ºé¡Œã«å¯¾å¿œ) ---
        let currentQuestion = null;

        if (typeof questionData === 'undefined') {
            alert("ã‚¨ãƒ©ãƒ¼ï¼š'questions.js' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            document.getElementById('question').innerText = "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        }

        function loadRandomQuestion() {
            // çµæœã‚¨ãƒªã‚¢ã‚’éš ã—ã¦ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('result').style.display = 'none';
            document.getElementById('options').innerHTML = '';
            
            let q;
            let candidateQuestions = [];
            const incorrectIds = getIncorrectQuestions();
            
            const categorySelect = document.getElementById('category-select');
            const orderSelect = document.getElementById('order-select'); 
            
            const selectedCategory = categorySelect ? categorySelect.value : 'all';
            const selectedOrder = orderSelect ? orderSelect.value : 'random'; 

            // 1. ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§å•é¡Œãƒªã‚¹ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredQuestions = questionData.filter(q => {
                return selectedCategory === 'all' || q.category === selectedCategory;
            });
            
            // IDé †ã«ä¸¦ã¹æ›¿ãˆã¦ãŠã
            filteredQuestions.sort((a, b) => a.id - b.id);


            if (reviewMode && incorrectIds.length > 0) {
                // 2-1. ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰: ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸä¸­ã‹ã‚‰ã€èª¤ç­”ãƒªã‚¹ãƒˆã«ã‚ã‚‹å•é¡Œã®ã¿ã‚’é¸å‡º
                candidateQuestions = filteredQuestions.filter(q => incorrectIds.includes(q.id));
                
                if (candidateQuestions.length === 0) {
                    alert(`é¸æŠä¸­ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆ${selectedCategory}ï¼‰ã«ã¯ã€èª¤ç­”ã—ãŸå•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã™ã€‚`);
                    toggleReviewMode();
                    return;
                }
                
                // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œ
                const randomIndex = Math.floor(Math.random() * candidateQuestions.length);
                q = candidateQuestions[randomIndex];

            } else if (selectedOrder === 'sequential') {
                // 2-2. IDé †ãƒ¢ãƒ¼ãƒ‰
                candidateQuestions = filteredQuestions;

                if (currentSequentialIndex >= candidateQuestions.length) {
                    currentSequentialIndex = 0; // å…¨å•è§£ãçµ‚ã‚ã£ãŸã‚‰æœ€åˆã«æˆ»ã‚‹
                    alert(`å…¨ ${candidateQuestions.length} å•ã‚’è§£ãçµ‚ã‚ã‚Šã¾ã—ãŸã€‚æœ€åˆã«æˆ»ã‚Šã¾ã™ã€‚`);
                }
                q = candidateQuestions[currentSequentialIndex];
                currentSequentialIndex++; // æ¬¡ã«å‚™ãˆã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é€²ã‚ã‚‹

            } else {
                // 2-3. ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚¹ãƒãƒ¼ãƒˆå‡ºé¡Œãƒ­ã‚¸ãƒƒã‚¯ã‚’é©ç”¨ï¼‰
                candidateQuestions = filteredQuestions;

                // å±¥æ­´ã‚’å–å¾—
                const history = getQuestionHistory();
                const now = Date.now();
                
                // å„å•é¡Œã«é‡ã¿ï¼ˆweightï¼‰ã‚’è¨ˆç®—
                const weightedQuestions = candidateQuestions.map(q => {
                    const h = history[q.id];
                    let weight = 1.0; // åŸºæœ¬ã®é‡ã¿
                    
                    if (h && h.total > 0) {
                        // â‘  æ­£ç­”ç‡ãŒä½ã„ã»ã©é‡ã¿ã‚’å¢—ã‚„ã™
                        const successRate = h.correct / h.total;
                        // æ­£ç­”ç‡ãŒ50%ãªã‚‰é‡ã¿1å€ã€0%ãªã‚‰é‡ã¿2å€ã«è¿‘ã¥ã
                        weight *= (2.0 - successRate); 
                        
                        // â‘¡ æœ€å¾Œã«æ­£è§£ã—ã¦ã‹ã‚‰æ™‚é–“ãŒçµŒã¤ã»ã©é‡ã¿ã‚’å¢—ã‚„ã™
                        const timeSinceCorrect = now - h.lastCorrect; // ãƒŸãƒªç§’
                        // 1æ—¥ä»¥ä¸Šæ­£è§£ãŒãªã„å ´åˆã«é‡ã¿ã‚’å¢—åŠ ã•ã›ã‚‹
                        const daysSinceCorrect = timeSinceCorrect / (1000 * 60 * 60 * 24); 
                        
                        // 1æ—¥çµŒéã”ã¨ã«é‡ã¿ãŒæœ€å¤§1.5å€ã¾ã§å¢—ãˆã‚‹ï¼ˆèª¿æ•´å¯èƒ½ï¼‰
                        if (daysSinceCorrect > 0) {
                            weight *= Math.min(1.5, 1 + (daysSinceCorrect * 0.1));
                        }
                    } else {
                        // æœªå›ç­”ã®å•é¡Œã¯é‡ã¿ã‚’é«˜ãè¨­å®šã—ã€å„ªå…ˆçš„ã«å‡ºé¡Œã™ã‚‹
                        weight = 3.0; 
                    }
                    
                    return { question: q, weight: weight };
                });

                // é‡ã¿ã®åˆè¨ˆã‚’è¨ˆç®—
                const totalWeight = weightedQuestions.reduce((sum, item) => sum + item.weight, 0);
                
                // ãƒ©ãƒ³ãƒ€ãƒ ãªé–¾å€¤ã‚’æ±ºå®š
                let randomThreshold = Math.random() * totalWeight;
                
                // é‡ã¿ä»˜ãæŠ½é¸ã‚’å®Ÿè¡Œ
                for (const item of weightedQuestions) {
                    randomThreshold -= item.weight;
                    if (randomThreshold <= 0) {
                        q = item.question;
                        break;
                    }
                }
                
                // ä¸‡ãŒä¸€æŠ½é¸ã«å¤±æ•—ã—ãŸã‚‰ã€é€šå¸¸ã®ãƒ©ãƒ³ãƒ€ãƒ é¸æŠã«æˆ»ã‚‹
                if (!q) {
                    const randomIndex = Math.floor(Math.random() * candidateQuestions.length);
                    q = candidateQuestions[randomIndex];
                }
            }

            if (candidateQuestions.length === 0) {
                document.getElementById('question').innerText = `ã‚¨ãƒ©ãƒ¼: é¸æŠã•ã‚ŒãŸåˆ†é‡ï¼ˆ${selectedCategory}ï¼‰ã«å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚questions.jsã«ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
                document.querySelector('.question-label').innerText = 'å•é¡Œãªã—';
                return;
            }

            currentQuestion = q; 

            // å•é¡Œæ–‡ã‚’è¡¨ç¤º
            let modeLabel = reviewMode ? "ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ï¼‰" : "";
            let categoryInfo = selectedCategory !== 'all' ? ` [${selectedCategory}]` : "";
            // IDé †ã®å ´åˆã¯ã€ç¾åœ¨ã®é€²æ—ã‚’è¡¨ç¤º
            let orderInfo = selectedOrder === 'sequential' && !reviewMode 
                ? ` (ID:${q.id}, ${currentSequentialIndex}/${filteredQuestions.length})` 
                : ` (ID:${q.id})`;
            
            let label = q.isMultiSelect ? `å•é¡Œ${modeLabel}ï¼ˆè¤‡æ•°é¸æŠï¼‰` : `å•é¡Œ${modeLabel}ï¼ˆå˜ä¸€é¸æŠï¼‰`;
            document.querySelector('.question-label').innerText = label + categoryInfo + orderInfo; 
            document.getElementById('question').innerText = q.text;
            
            // é¸æŠè‚¢ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
            q.options.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = option;

                // è¤‡æ•°é¸æŠå•é¡Œã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
                if (q.isMultiSelect) {
                    // è¤‡æ•°é¸æŠã®å ´åˆã€ã‚¯ãƒªãƒƒã‚¯ã§ã‚¯ãƒ©ã‚¹ã‚’ãƒˆã‚°ãƒ«ã™ã‚‹ã ã‘ï¼ˆåˆ¤å®šã¯ã—ãªã„ï¼‰
                    btn.onclick = () => {
                        btn.classList.toggle('selected');
                    };
                } else {
                    // å˜ä¸€é¸æŠã®å ´åˆã®ã¿ã€ã‚¯ãƒªãƒƒã‚¯ã§åˆ¤å®šé–¢æ•°ã‚’å‘¼ã¶
                    btn.onclick = () => checkSingleAnswer(index, q);
                }
                document.getElementById('options').appendChild(btn);
            });

            // åˆ¤å®šãƒœã‚¿ãƒ³ã®ç”Ÿæˆ
            if (q.isMultiSelect) {
                const checkBtn = document.createElement('button');
                checkBtn.className = 'check-multi-btn'; 
                checkBtn.innerText = 'è§£ç­”ã‚’åˆ¤å®šã™ã‚‹';
                checkBtn.onclick = () => checkMultiAnswer(checkBtn); 
                document.getElementById('options').appendChild(checkBtn);
            }
        }
        
        // --- åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---
        function checkSingleAnswer(selectedIndex, q) {
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(btn => btn.disabled = true); 

            const resultArea = document.getElementById('result');
            const resultTitle = document.getElementById('result-title');
            const explanationSpan = document.getElementById('explanation-text');
            
            const correctIndex = q.correctIndex; 
            const isCorrect = selectedIndex === correctIndex; 

            if (isCorrect) {
                buttons[selectedIndex].classList.add('correct');
                resultTitle.innerText = "â— æ­£è§£ï¼ç´ æ™´ã‚‰ã—ã„ï¼";
                resultTitle.style.color = "#2a9d8f";
                resultArea.style.borderLeftColor = "#2a9d8f";
            } else {
                buttons[selectedIndex].classList.add('wrong');
                if (correctIndex !== undefined && correctIndex >= 0 && correctIndex < buttons.length) {
                    buttons[correctIndex].classList.add('correct'); 
                }
                
                resultTitle.innerText = "âœ• æ®‹å¿µ... èª¤ç­”ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸã€‚";
                resultTitle.style.color = "#e76f51";
                resultArea.style.borderLeftColor = "#e76f51";
            }

            explanationSpan.innerHTML = q.explanation;
            resultArea.style.display = 'block';
            
            // å­¦ç¿’å±¥æ­´ã®æ›´æ–°
            updateQuestionHistory(q.id, isCorrect); 
        }

        function checkMultiAnswer(clickedCheckBtn) {
            if (!currentQuestion || !currentQuestion.isMultiSelect) {
                console.error("ã‚¨ãƒ©ãƒ¼: ç¾åœ¨ã®å•é¡ŒãŒè¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }

            if (!currentQuestion.correctIndices || !Array.isArray(currentQuestion.correctIndices)) {
                // ã‚¨ãƒ©ãƒ¼å‡¦ç†
                const resultArea = document.getElementById('result');
                document.getElementById('result-title').innerText = "ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼: å•é¡Œã®æ­£è§£ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
                document.getElementById('result-title').style.color = "#ff4444";
                resultArea.style.borderLeftColor = "#ff4444";
                document.getElementById('explanation-text').innerHTML = "questions.js ã®å•é¡ŒID " + currentQuestion.id + " ã« **`correctIndices: [...]`** ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
                resultArea.style.display = 'block';
                document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
                clickedCheckBtn.disabled = true;
                return;
            }

            const buttons = document.querySelectorAll('.option-btn');
            const selectedIndices = [];
            buttons.forEach((btn, index) => {
                if (btn.classList.contains('selected')) {
                    selectedIndices.push(index);
                }
            });

            const correct = currentQuestion.correctIndices.sort((a, b) => a - b).toString();
            const userSelected = selectedIndices.sort((a, b) => a - b).toString();

            const isCorrect = correct === userSelected;

            buttons.forEach(btn => btn.disabled = true);
            clickedCheckBtn.disabled = true; 

            const resultArea = document.getElementById('result');
            const resultTitle = document.getElementById('result-title');
            const explanationSpan = document.getElementById('explanation-text');
            
            if (isCorrect) {
                resultTitle.innerText = "â— å®Œå…¨æ­£è§£ï¼";
                resultTitle.style.color = "#2a9d8f";
                resultArea.style.borderLeftColor = "#2a9d8f";
            } else {
                resultTitle.innerText = "âœ• ä¸æ­£è§£... èª¤ç­”ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸã€‚";
                resultTitle.style.color = "#e76f51";
                resultArea.style.borderLeftColor = "#e76f51";
            }

            buttons.forEach((btn, index) => {
                const isUserSelected = selectedIndices.includes(index);
                const isActuallyCorrect = currentQuestion.correctIndices.includes(index);
                
                if (isActuallyCorrect) {
                    btn.classList.add('correct'); 
                } else if (isUserSelected) {
                    btn.classList.add('wrong'); 
                }
            });

            explanationSpan.innerHTML = currentQuestion.explanation;
            resultArea.style.display = 'block';

            // å­¦ç¿’å±¥æ­´ã®æ›´æ–°
            updateQuestionHistory(currentQuestion.id, isCorrect);
        }


        // ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸã¨ãã«æœ€åˆã®å•é¡Œã‚’å‡ºã—ã€ãƒœã‚¿ãƒ³ã®æ•°ã‚’æ›´æ–°
        if (typeof questionData !== 'undefined') {
            setupCategories(); 
            loadRandomQuestion();
            updateReviewButton();
        }
    </script>
</body>
</html>
